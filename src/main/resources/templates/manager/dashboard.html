<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{decorators/manager-layout}">
<head>
    <meta charset="utf-8"/>
    <title>Dashboard</title>

    <style>
        .dashboard-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 1rem;
        }

        .card-box {
            background-color: #FAFAF2;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border-left: 6px solid #DC92B3;
            transition: 0.3s;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.06);
        }

        .card-box:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.12);
        }

        .label { font-size: 1rem; color: #6b6b6b; margin-bottom: 6px; }
        .value { font-size: 2rem; font-weight: bold; color: #DC92B3; }

        .new { border-left-color: #FAD1CE; }
        .unpaid { border-left-color: #FF9F9F; }
        .paid { border-left-color: #C8E4B2; }
        .cancelled { border-left-color: #B8A7EA; }
        .revenue { border-left-color: #DC92B3; }

        .chart-card {
            background: #FAFAF2;
            border-radius: 15px;
            padding: 20px;
            margin-top: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .chart-card h5 { color: #DC92B3; margin-bottom: 12px; }

        .filter-box {
            display:flex;
            gap:10px;
            align-items:center;
            margin-top:18px;
            flex-wrap:wrap;
        }

        @media (max-width: 768px) {
            .value { font-size: 1.4rem; }
            .filter-box { flex-direction: column; align-items: stretch; gap:8px; }
        }

        .btn-pink { background:#DC92B3; color:white; border:none; padding:8px 14px; border-radius:8px; }
        .btn-pink:disabled { opacity:0.6; }
    </style>

    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>
<body>
<section layout:fragment="content" class="px-4 mt-3">

    <h3 class="fw-bold" style="color: #DC92B3;">T·ªïng quan c·ª≠a h√†ng</h3>

    <!-- Cards -->
    <div class="dashboard-cards">
        <div class="card-box new">
            <div class="label">T·ªïng ƒë∆°n h√†ng</div>
            <div class="value" th:text="${totalOrders != null ? totalOrders : 0}">0</div>
        </div>

        <div class="card-box unpaid">
            <div class="label">Ch∆∞a thanh to√°n</div>
            <div class="value" th:text="${unpaid != null ? unpaid : 0}">0</div>
        </div>

        <div class="card-box paid">
            <div class="label">ƒê√£ thanh to√°n</div>
            <div class="value" th:text="${paid != null ? paid : 0}">0</div>
        </div>

        <div class="card-box cancelled">
            <div class="label">ƒê√£ h·ªßy</div>
            <div class="value" th:text="${cancelled != null ? cancelled : 0}">0</div>
        </div>

        <div class="card-box revenue">
            <div class="label">Doanh thu</div>
            <div class="value">
                <span th:text="${#numbers.formatDecimal(revenue != null ? revenue : 0, 0, 'COMMA', 0, 'POINT')}">0</span> ‚Ç´
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="filter-box">
        <select id="timeFilter" class="form-select" style="max-width:220px;">
            <option value="thisMonth">Th√°ng n√†y</option>
            <option value="today">H√¥m nay</option>
            <option value="7days">7 ng√†y g·∫ßn nh·∫•t</option>
            <option value="custom">T√πy ch·ªçn ng√†y</option>
        </select>

        <input type="date" id="fromDate" class="form-control" style="max-width:180px;"
               th:value="${from != null ? #temporals.format(from,'yyyy-MM-dd') : ''}" />

        <input type="date" id="toDate" class="form-control" style="max-width:180px;"
               th:value="${to != null ? #temporals.format(to,'yyyy-MM-dd') : ''}" />

        <select id="granularity" class="form-select" style="max-width:160px;">
            <option value="day" th:selected="${granularity == 'day'}">Ng√†y</option>
            <option value="week" th:selected="${granularity == 'week'}">Tu·∫ßn</option>
            <option value="month" th:selected="${granularity == 'month'}">Th√°ng</option>
        </select>

        <button id="applyFilter" class="btn-pink" style="margin-left:6px;">√Åp d·ª•ng</button>
        <a th:href="@{/manager/dashboard}" class="btn btn-outline-secondary" style="margin-left:6px;">L√†m m·ªõi</a>
    </div>

    <hr/>

    <!-- Revenue Chart -->
    <div class="chart-card">
        <h5>üìà Doanh thu theo th·ªùi gian</h5>
        <div id="revenueChart"></div>
    </div>

    <!-- Top Selling Chart -->
    <div class="chart-card">
        <h5>üî• Top s·∫£n ph·∫©m b√°n ch·∫°y</h5>
        <div id="topSellingChart"></div>
    </div>

    <!-- Status Pie Chart -->
    <div class="chart-card">
        <h5>üßæ T·ªâ l·ªá tr·∫°ng th√°i ƒë∆°n h√†ng</h5>
        <div id="orderStatusChart"></div>
    </div>

    <!-- hidden container to expose server-side data in a safe way -->
    <div id="serverData" style="display:none"
         th:data-series="${series != null ? series : {}}"
         th:data-variantnames="${variantNames != null ? variantNames : {}}"
         th:data-soldcounts="${soldCounts != null ? soldCounts : {}}"
         th:data-pending="${pendingCount != null ? pendingCount : 0}"
         th:data-confirmed="${confirmedCount != null ? confirmedCount : 0}"
         th:data-shipping="${shippingCount != null ? shippingCount : 0}"
         th:data-delivered="${deliveredCount != null ? deliveredCount : 0}"
         th:data-canceled="${canceledCount != null ? canceledCount : 0}"
         th:data-returned="${returnedCount != null ? returnedCount : 0}"
         th:data-from="${from != null ? #temporals.format(from,'yyyy-MM-dd') : ''}"
         th:data-to="${to != null ? #temporals.format(to,'yyyy-MM-dd') : ''}"
         th:data-granularity="${granularity != null ? granularity : 'day'}">
    </div>


<!-- Inline JS: use Thymeleaf inlined expressions only where necessary (below), then all DOM listeners outside -->
<script th:inline="javascript">
/*<![CDATA[*/
    // NOTE: using th:inline="javascript" so Thymeleaf will render collections as JS literals
    var revenueLabels = /*[[${series != null ? series.keySet() : {} }]]*/ [];
    var revenueValues = /*[[${series != null ? series.values() : {} }]]*/ [];

    // topVariants expected as list of arrays/tuples: [[label, value], ...]
    var topLabels = /*[[${variantNames}]]*/ [];
    var topValues = /*[[${soldCounts}]]*/ [];

    var pendingCount = /*[[${pendingCount != null ? pendingCount : 0}]]*/ 0;
    var confirmedCount = /*[[${confirmedCount != null ? confirmedCount : 0}]]*/ 0;
    var shippingCount = /*[[${shippingCount != null ? shippingCount : 0}]]*/ 0;
    var deliveredCount = /*[[${deliveredCount != null ? deliveredCount : 0}]]*/ 0;
    var canceledCount = /*[[${canceledCount != null ? canceledCount : 0}]]*/ 0;
    var returnedCount = /*[[${returnedCount != null ? returnedCount : 0}]]*/ 0;
/*]]>*/
</script>

<script>
    // === Helper to convert Thymeleaf-rendered collections to JS arrays if necessary ===
    // (In many setups the inlined Thymeleaf expressions above already yield usable arrays;
    //  this block ensures backward compatibility if series/keySet rendered as Map-like string.)
    function ensureArray(x) {
        if (x === null || x === undefined) return [];
        if (Array.isArray(x)) return x;
        if (typeof x === 'string') {
            try {
                return JSON.parse(x);
            } catch (e) {
                // fallback: split by comma (not ideal but safe)
                return x.split(',').map(s => s.trim());
            }
        }
        // try to convert iterable
        try {
            return Array.from(x);
        } catch (e) {
            return [];
        }
    }

    revenueLabels = ensureArray(revenueLabels);
    revenueValues = ensureArray(revenueValues).map(v => parseFloat(v) || 0);
    topLabels = ensureArray(topLabels);
    topValues = ensureArray(topValues).map(v => parseFloat(v) || 0);

    // --- Render charts ---
    function renderRevenueChart() {
        var el = document.querySelector("#revenueChart");
        if (!el) return;
        new ApexCharts(el, {
            chart: { type: 'line', height: 340, toolbar: { show: true } },
            series: [{ name: 'Doanh thu', data: revenueValues }],
            xaxis: { categories: revenueLabels, labels: { rotate: -20 } },
            stroke: { curve: 'smooth' },
            tooltip: { y: { formatter: function(val){ return new Intl.NumberFormat('vi-VN').format(val) + ' ‚Ç´'; } } }
        }).render();
    }

    function renderTopSellingChart() {
        var el = document.querySelector("#topSellingChart");
        if (!el) return;
        new ApexCharts(el, {
            chart: { type: 'bar', height: 340 },
            series: [{ name: "ƒê√£ b√°n", data: topValues }],
            xaxis: { categories: topLabels },
            plotOptions: { bar: { distributed: false, borderRadius: 6 } },
            tooltip: { y: { formatter: function(val){ return parseInt(val); } } }
        }).render();
    }

    function renderStatusPie() {
        var el = document.querySelector("#orderStatusChart");
        if (!el) return;
        var labels = ['ƒê∆°n m·ªõi', 'ƒê√£ x√°c nh·∫≠n', 'ƒêang giao', 'Ho√†n th√†nh', 'ƒê√£ h·ªßy', 'Tr·∫£ h√†ng'];
        var values = [pendingCount, confirmedCount, shippingCount, deliveredCount, canceledCount, returnedCount];
        new ApexCharts(el, {
            chart: { type: 'pie', height: 330 },
            series: values,
            labels: labels,
            legend: { position: 'bottom' },
            tooltip: { y: { formatter: function(val){ return val; } } }
        }).render();
    }

    // initial render
    renderRevenueChart();
    renderTopSellingChart();
    renderStatusPie();

    // === Filter logic and UI state sync ===
    const timeFilter = document.getElementById("timeFilter");
    const fromDate = document.getElementById("fromDate");
    const toDate = document.getElementById("toDate");
    const applyBtn = document.getElementById("applyFilter");
    const granEl = document.getElementById("granularity");
    const server = document.getElementById("serverData");

    // set initial UI state from model (serverData attributes)
    (function syncInitialState() {
        if (!server) return;
        const sFrom = server.getAttribute('data-from') || '';
        const sTo = server.getAttribute('data-to') || '';
        const sGran = server.getAttribute('data-granularity') || 'day';

        granEl.value = sGran;

        // if both from/to present, set custom, else try to guess (thisMonth/today/7days)
        if (sFrom && sTo) {
            // if from==to -> treat as today
            const f = new Date(sFrom);
            const t = new Date(sTo);
            const now = new Date();
            // normalize
            function isSameDay(a,b){ return a.getFullYear()===b.getFullYear() && a.getMonth()===b.getMonth() && a.getDate()===b.getDate(); }

            if (isSameDay(f, now) && isSameDay(t, now)) {
                timeFilter.value = 'today';
            } else {
                // check if from is first day of this month and to is today -> thisMonth
                const firstOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                if (isSameDay(f, firstOfMonth) && t >= now) {
                    timeFilter.value = 'thisMonth';
                } else {
                    // check 7days
                    const sevenAgo = new Date(); sevenAgo.setDate(now.getDate() - 7);
                    if (f >= sevenAgo && t >= now) {
                        timeFilter.value = '7days';
                    } else {
                        timeFilter.value = 'custom';
                    }
                }
            }
            // set date inputs
            fromDate.value = sFrom;
            toDate.value = sTo;
        } else {
            // no from/to: default choose thisMonth
            timeFilter.value = 'thisMonth';
        }

        // enable/disable date inputs according to selection
        toggleDateInputs(timeFilter.value === 'custom');
        applyBtn.disabled = (timeFilter.value !== 'custom');
    })();

    function toggleDateInputs(enable) {
        fromDate.disabled = !enable;
        toDate.disabled = !enable;
        applyBtn.disabled = !enable;
    }

    // event listeners
    timeFilter.addEventListener('change', function () {
        const type = timeFilter.value;
        if (type === 'custom') {
            toggleDateInputs(true);
            return;
        }
        toggleDateInputs(false);

        // compute from/to and redirect with params
        const now = new Date();
        let from, to;
        if (type === 'today') {
            from = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            to = now;
        } else if (type === '7days') {
            from = new Date(); from.setDate(now.getDate() - 7);
            to = now;
        } else if (type === 'thisMonth') {
            from = new Date(now.getFullYear(), now.getMonth(), 1);
            to = now;
        } else {
            // fallback: reload current page
            return;
        }

        // build URL and redirect
        const url = new URL(window.location.href);
        url.searchParams.set('from', new Date(from).toISOString());
        url.searchParams.set('to', new Date(to).toISOString());
        url.searchParams.set('granularity', granEl.value || 'day');
        window.location.href = url.toString();
    });

    applyBtn.addEventListener('click', function () {
        const f = fromDate.value;
        const t = toDate.value;
        if (!f || !t) { alert('Vui l√≤ng ch·ªçn c·∫£ t·ª´ v√† ƒë·∫øn ng√†y'); return; }
        const fromISO = new Date(f + 'T00:00:00').toISOString();
        const toISO = new Date(t + 'T23:59:59').toISOString();

        const url = new URL(window.location.href);
        url.searchParams.set('from', fromISO);
        url.searchParams.set('to', toISO);
        url.searchParams.set('granularity', granEl.value || 'day');
        window.location.href = url.toString();
    });

</script>
</section>
</body>
</html>
