<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>V√≠ Voucher | OneShop</title>

  <!-- ƒê·ªìng b·ªô giao di·ªán OneShop -->
  <link rel="stylesheet" th:href="@{/css/header.css}">
  <link rel="stylesheet" th:href="@{/css/footer.css}">
  <link rel="stylesheet" th:href="@{/css/voucher-wallet.css}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
.voucher-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(330px, 1fr));
  gap: 24px;
  margin-top: 20px;
}
.voucher-card {
  display: flex;
  justify-content: space-between;
  background: #fff;
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  transition: 0.25s;
}
.voucher-card:hover { transform: translateY(-3px); }
.voucher-code { font-size: 18px; font-weight: 600; color: #222; }
.voucher-details { list-style: none; padding-left: 0; margin: 10px 0; font-size: 14px; }
.voucher-details li { margin-bottom: 4px; color: #333; }
.voucher-date { font-size: 13px; color: #666; }
.voucher-actions { text-align: right; display: flex; flex-direction: column; align-items: flex-end; }
.btn-apply {
  background: #b8c9e8;
  color: #111;
  border-radius: 999px;
  padding: 6px 16px;
  text-decoration: none;
  margin-top: 8px;
  transition: 0.25s;
}
.btn-apply:hover { background: #9fb7e0; }
.btn-disabled {
  background: #ccc !important;
  color: #666 !important;
  cursor: not-allowed;
}
.note-disabled {
  color: #c2410c;
  font-size: 13px;
  margin-top: 5px;
}
</style>
</head>

<body>
  <div th:replace="~{fragments/_header :: header}"></div>
  <p th:text="'Voucher size: ' + ${#lists.size(vouchers)}"></p>  <!-- Gi·ªØ ƒë·ªÉ debug, sau x√≥a n·∫øu OK -->
  
<main class="account-page container" style="margin-top: 140px; padding-bottom: 60px;">
  <div class="account-wrapper">
    <!-- Sidebar -->
    <aside class="account-sidebar">
      <ul>
        <li><a th:href="@{/account}">Th√¥ng tin t√†i kho·∫£n</a></li>
        <li><a th:href="@{/account/orders}">L·ªãch s·ª≠ ƒë∆°n h√†ng</a></li>
        <li class="active"><a th:href="@{/account/vouchers}">V√≠ Voucher</a></li>
        <li><a th:href="@{/account/addresses}">ƒê·ªãa ch·ªâ giao h√†ng</a></li>
        <li><a th:href="@{/account/wishlist}">Danh s√°ch y√™u th√≠ch</a></li>
        <li><a th:href="@{/logout}">ƒêƒÉng xu·∫•t</a></li>
      </ul>
    </aside>

    <!-- N·ªôi dung ch√≠nh -->
    <section class="account-content">
      <!-- Th√¥ng b√°o -->
      <div th:if="${err}" style="background:#fee2e2; color:#b91c1c; padding:10px 15px; border-radius:8px; margin-bottom:15px;">
        <i class="fa-solid fa-circle-exclamation"></i> <span th:text="${err}"></span>
      </div>
      <div th:if="${msg}" style="background:#dcfce7; color:#166534; padding:10px 15px; border-radius:8px; margin-bottom:15px;">
        <i class="fa-solid fa-circle-check"></i> <span th:text="${msg}"></span>
      </div>

      <h2 class="page-title">üéÅ V√≠ Voucher</h2>

      <div class="voucher-list" th:if="${vouchers != null and !vouchers.isEmpty()}">
        <div class="voucher-card" th:each="v : ${vouchers}"
             th:attr="data-min=${v.minOrderValue}, data-id=${v.voucherId}">
          <div class="voucher-info">
            <h3 class="voucher-code" th:text="${v.code}">CODE123</h3>
            <p class="voucher-name" th:text="${v.name ?: ''}"></p>
            <ul class="voucher-details">
              <li th:if="${v.discountType?.name() == 'PERCENT'}">
                Gi·∫£m <span th:text="${v.discountPercent}"></span>%
                (t·ªëi ƒëa <span th:text="${v.maxDiscountValue != null ? #numbers.formatDecimal(v.maxDiscountValue, 0, 'COMMA', 0, 'POINT') + '‚Ç´' : 'Kh√¥ng gi·ªõi h·∫°n'}"></span>)
              </li>
              <li th:if="${v.discountType?.name() == 'AMOUNT'}">
                Gi·∫£m <span th:text="${v.discountAmount != null ? #numbers.formatDecimal(v.discountAmount, 0, 'COMMA', 0, 'POINT') + '‚Ç´' : '0‚Ç´'}"></span>
              </li>
              <li th:if="${v.discountType?.name() == 'FREESHIP'}">Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn üöö</li>
              <li th:text="${'ƒê∆°n t·ªëi thi·ªÉu: ' + (v.minOrderValue != null ? #numbers.formatDecimal(v.minOrderValue, 0, 'COMMA', 0, 'POINT') + ' ‚Ç´' : '0 ‚Ç´')}"></li>
            </ul>
            <p class="voucher-date">HSD: <span th:text="${#temporals.format(v.endDate, 'dd/MM/yyyy')}"></span></p>
          </div>

          <div class="voucher-actions">
            <div class="voucher-usage-row">
<div class="voucher-usage-row">
  <p class="voucher-usage" th:text="'C√≤n ' + (${v.usageLimit - v.usedCount})"></p>
</div>

<div class="voucher-actions">
  <a href="#" class="voucher-condition">ƒêi·ªÅu ki·ªán</a>
  <a th:href="@{'/account/vouchers/apply/' + ${v.voucherId}}" class="btn-apply">Ch·ªçn</a>
</div>

<p class="note-disabled" style="display:none;">‚ùå ƒê∆°n ch∆∞a ƒë·ªß ƒëi·ªÅu ki·ªán</p>


          </div>
        </div>
      </div>

      <div class="empty" th:if="${vouchers == null or vouchers.isEmpty()}">
        <p>Hi·ªán b·∫°n ch∆∞a c√≥ voucher n√†o üíú</p>
      </div>
    </section>
  </div>
</main>


  <div class="modal-overlay" id="voucherModal">
    <div class="modal-box">
      <h3 id="modalTitle">Th√¥ng tin Voucher</h3>
      <p><strong>M√£:</strong> <span id="mCode"></span></p>
      <p><strong>T√™n:</strong> <span id="mName"></span></p>
      <p><strong>Lo·∫°i khuy·∫øn m√£i:</strong> <span id="mType"></span></p>
      <p><strong>Gi√° tr·ªã gi·∫£m:</strong> <span id="mValue"></span></p>
      <p><strong>ƒê∆°n h√†ng t·ªëi thi·ªÉu:</strong> <span id="mMin"></span>‚Ç´</p>
      <p><strong>Th·ªùi gian √°p d·ª•ng:</strong> <span id="mStart"></span> ‚Üí <span id="mEnd"></span></p>
      <p><strong>Tr·∫°ng th√°i:</strong> <span id="mStatus"></span></p>
      <p><strong>ƒêi·ªÅu ki·ªán chi ti·∫øt:</strong><br><span id="mDesc"></span></p>
      <button class="modal-close" onclick="closeModal()">ƒê√≥ng</button>
    </div>
  </div>

  <div th:replace="~{fragments/_footer :: footer}"></div>

  <script>
    // M·ªü popup
    document.querySelectorAll('.voucher-condition').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        const card = e.target.closest('.voucher-card');
        document.getElementById('mCode').textContent = card.dataset.code;
        document.getElementById('mName').textContent = card.dataset.name;
        document.getElementById('mType').textContent = card.dataset.type;
        document.getElementById('mMin').textContent = parseInt(card.dataset.min).toLocaleString();
        document.getElementById('mStart').textContent = card.dataset.start;
        document.getElementById('mEnd').textContent = card.dataset.end;
        document.getElementById('mStatus').textContent = card.dataset.status;
        document.getElementById('mDesc').textContent = card.dataset.desc;

        // X√°c ƒë·ªãnh gi√° tr·ªã gi·∫£m hi·ªÉn th·ªã
        let val = '';
        if (card.dataset.type === 'PERCENT') {
          val = `${card.dataset.percent}% (T·ªëi ƒëa ${parseInt(card.dataset.max).toLocaleString()}‚Ç´)`;
        } else if (card.dataset.type === 'AMOUNT') {
          val = `${parseInt(card.dataset.amount).toLocaleString()}‚Ç´`;
        } else {
          val = 'Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn';
        }
        document.getElementById('mValue').textContent = val;

        document.getElementById('voucherModal').style.display = 'flex';
      });
    });

    // ƒê√≥ng popup
    function closeModal() {
      document.getElementById('voucherModal').style.display = 'none';
    }

    // ƒê√≥ng khi b·∫•m ngo√†i v√πng box
    document.getElementById('voucherModal').addEventListener('click', e => {
      if (e.target.id === 'voucherModal') closeModal();
    });
  </script>
  
  <script>
document.addEventListener('DOMContentLoaded', () => {
  const cartTotal = parseFloat('[[${cartTotal}]]') || 0;
  document.querySelectorAll('.voucher-card').forEach(card => {
    const min = parseFloat(card.dataset.min || 0);
    const btn = card.querySelector('.btn-apply');
    const note = card.querySelector('.note-disabled');
    if (cartTotal < min) {
      btn.classList.add('btn-disabled');
      btn.removeAttribute('href');
      note.style.display = 'block';
    }
  });
});
</script>
  
</body>
</html>
