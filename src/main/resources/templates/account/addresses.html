<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>ƒê·ªãa ch·ªâ giao h√†ng | OneShop</title>

  <!-- ƒê·ªìng b·ªô giao di·ªán OneShop -->
  <link rel="stylesheet" th:href="@{/css/header.css}">
  <link rel="stylesheet" th:href="@{/css/footer.css}">
  <link rel="stylesheet" th:href="@{/css/address.css}">

  <style>
    /* Tr√°nh header c·ªë ƒë·ªãnh che n·ªôi dung */
    main.account-page { margin-top: 140px; padding-bottom: 60px; }

    /* Ti√™u ƒë·ªÅ + n√∫t th√™m */
    .title-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .title-row h2{margin:0}
    .btn-add{background:#b8c9e8;border:none;padding:10px 14px;border-radius:999px;color:#111;cursor:pointer}
    .btn-add:hover{filter:brightness(1.05)}
    
    /* === Th√¥ng b√°o pastel (th√†nh c√¥ng / l·ªói) === */
.alert {
  padding: 12px 18px;
  border-radius: 10px;
  margin-bottom: 15px;
  font-size: 15px;
  font-weight: 500;
  display: flex;
  align-items: center;
  justify-content: space-between;
  animation: fadeIn 0.3s ease-in-out;
}

.alert.success {
  background: #f3f9f3;
  border-left: 5px solid #90d48a;
  color: #2e7d32;
}

.alert.error {
  background: #fff0f0;
  border-left: 5px solid #f19999;
  color: #c62828;
}
    

    /* Label tr∆∞·ªõc d·ªØ li·ªáu */
    .label{font-weight:600;color:#555;margin-right:6px}

    /* Modal */
    .modal{display:none;position:fixed;z-index:9999;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.45);backdrop-filter:blur(3px)}
    .modal-content{background:#fff;border-radius:20px;max-width:520px;margin:80px auto;padding:30px 40px;position:relative;box-shadow:0 6px 20px rgba(0,0,0,.1);animation:fadeIn .25s ease-out}
    @keyframes fadeIn{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}
    .modal-content h3{text-align:center;font-size:20px;margin-bottom:20px;color:#222}
    .modal-content label{display:block;font-weight:500;margin-top:10px;margin-bottom:4px;color:#333}
    .modal-content input,.modal-content select{width:100%;padding:8px 10px;border-radius:10px;border:1px solid #ccc;font-size:14px}
    .modal-content input:focus,.modal-content select:focus{border-color:#e8b4d1;outline:none}

    .modal-content .btn-row{display:flex;justify-content:flex-end;margin-top:20px;gap:10px}
    .btn-cancel{background:#ddd;color:#111;padding:8px 16px;border-radius:8px;border:none;cursor:pointer}
    .btn-save{background:#111;color:#fff;padding:8px 16px;border-radius:8px;border:none;cursor:pointer}
    .close{position:absolute;right:15px;top:10px;font-size:22px;cursor:pointer;color:#555}
    .close:hover{color:#000}
  </style>
</head>

<body>
<!-- Header -->
<div th:replace="~{fragments/_header :: header}"></div>

<main class="account-page container">
  <div class="account-wrapper">
    <!-- Sidebar -->
    <aside class="account-sidebar">
      <ul>
        <li><a th:href="@{/account}">Th√¥ng tin t√†i kho·∫£n</a></li>
        <li><a th:href="@{/account/orders}">L·ªãch s·ª≠ ƒë∆°n h√†ng</a></li>
        <li><a th:href="@{/account/vouchers}">V√≠ Voucher</a></li>
        <li class="active"><a th:href="@{/account/addresses}">ƒê·ªãa ch·ªâ giao h√†ng</a></li>
        <li><a th:href="@{/account/wishlist}">Danh s√°ch y√™u th√≠ch</a></li>
        <li><a th:href="@{/logout}">ƒêƒÉng xu·∫•t</a></li>
      </ul>
    </aside>

    <!-- N·ªôi dung -->
    <section class="account-content">
          <!-- üîî Th√¥ng b√°o th√†nh c√¥ng / l·ªói -->
<div th:if="${msgSuccess}" class="alert success">
  <span th:text="${msgSuccess}"></span>
</div>

<div th:if="${msgError}" class="alert error">
  <span th:text="${msgError}"></span>
</div>
      <div class="title-row">
        <h2>ƒê·ªãa ch·ªâ c·ªßa t√¥i</h2>
        <button class="btn-add" onclick="openAddressModal()">+ Th√™m ƒë·ªãa ch·ªâ m·ªõi</button>
      </div>

      <div class="address-list">
        <div th:if="${#lists.isEmpty(addresses)}" class="no-data">
          <p>Ch∆∞a c√≥ ƒë·ªãa ch·ªâ n√†o. H√£y th√™m ƒë·ªãa ch·ªâ m·ªõi!</p>
        </div>

        <div th:each="addr : ${addresses}" class="address-item">
          <div class="address-header">
            <h4>
              <span class="label">T√™n:</span>
              <span th:text="${addr.receiverName}">‚Äî</span>
              <span th:if="${addr.isDefault}" class="badge-default">‚òÖ M·∫∑c ƒë·ªãnh</span>
            </h4>
          </div>

          <p><span class="label">S·ªë ƒëi·ªán tho·∫°i:</span><span th:text="${addr.phone}">‚Äî</span></p>
          <p><span class="label">ƒê·ªãa ch·ªâ:</span>
            <span th:text="${addr.addressLine} + ', ' + ${addr.ward} + ', ' + ${addr.district} + ', ' + ${addr.city}">‚Äî</span>
          </p>

          <div class="actions">
            <button type="button" class="btn-update"
                    th:onclick="'editAddress(' + ${addr.addressId} + ')'">C·∫≠p nh·∫≠t</button>

            <form th:action="@{'/account/addresses/delete/' + ${addr.addressId}}" method="post">
              <button type="submit" class="btn-delete">X√≥a</button>
            </form>

            <form th:if="${!addr.isDefault}"
                  th:action="@{'/account/addresses/set-default/' + ${addr.addressId}}"
                  method="post">
              <button type="submit" class="btn-default">ƒê·∫∑t l√†m m·∫∑c ƒë·ªãnh</button>
            </form>
          </div>
        </div>
      </div>
    </section>
  </div>
</main>

<!-- Footer -->
<div th:replace="~{fragments/_footer :: footer}"></div>

<!-- Modal th√™m / c·∫≠p nh·∫≠t -->
<div id="addressModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeAddressModal()">&times;</span>
    <h3 id="modalTitle">Th√™m ƒë·ªãa ch·ªâ m·ªõi</h3>

    <form th:action="@{/account/addresses/save}" method="post" id="addressForm">
      <input type="hidden" name="addressId" id="addressId">

      <label>H·ªç t√™n</label>
      <input type="text" name="receiverName" id="receiverName" placeholder="Nh·∫≠p h·ªç t√™n" required>

      <label>S·ªë ƒëi·ªán tho·∫°i</label>
      <input type="text" name="phone" id="phone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i" required>

      <label>T·ªânh / Th√†nh ph·ªë</label>
      <select id="city" name="city" required>
        <option value="">-- Ch·ªçn T·ªânh / Th√†nh ph·ªë --</option>
      </select>

      <label>Qu·∫≠n / Huy·ªán</label>
      <select id="district" name="district" required>
        <option value="">-- Ch·ªçn Qu·∫≠n / Huy·ªán --</option>
      </select>

      <label>X√£ / Ph∆∞·ªùng</label>
      <select id="ward" name="ward" required>
        <option value="">-- Ch·ªçn X√£ / Ph∆∞·ªùng --</option>
      </select>

      <label>ƒê·ªãa ch·ªâ (s·ªë nh√†, ƒë∆∞·ªùng)</label>
      <input type="text" name="addressLine" id="addressLine" placeholder="V√≠ d·ª•: 123 ƒë∆∞·ªùng A..." required>


      <div class="btn-row">
        <button type="button" class="btn-cancel" onclick="closeAddressModal()">ƒê√≥ng</button>
        <button type="submit" class="btn-save">L∆∞u</button>
      </div>
    </form>
  </div>
</div>

<script>
  // M·ªü popup th√™m m·ªõi
  async function openAddressModal() {
    const modal = document.getElementById('addressModal');
    const form = document.getElementById('addressForm');

    document.getElementById('modalTitle').innerText = 'Th√™m ƒë·ªãa ch·ªâ m·ªõi';
    form.reset();
    document.getElementById('addressId').value = '';

    modal.style.display = 'block';
    await prepareForCreateAddress(); // n·∫°p dropdown t·ªânh/th√†nh
  }

  // ƒê√≥ng popup
  function closeAddressModal() {
    document.getElementById('addressModal').style.display = 'none';
  }

  // M·ªü popup c·∫≠p nh·∫≠t
  async function editAddress(id) {
    try {
      const res = await fetch(`/account/addresses/${id}`);
      if (!res.ok) throw new Error('Kh√¥ng t√¨m th·∫•y ƒë·ªãa ch·ªâ!');
      const data = await res.json();

      document.getElementById('addressModal').style.display = 'block';
      document.getElementById('modalTitle').innerText = 'C·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ';
      document.getElementById('addressId').value = data.addressId;
      document.getElementById('receiverName').value = data.receiverName || '';
      document.getElementById('phone').value = data.phone || '';
      document.getElementById('addressLine').value = data.addressLine || '';
    

      await prefillAdministrative(data.city, data.district, data.ward);
    } catch (e) {
      console.error(e);
      alert('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ƒë·ªãa ch·ªâ!');
    }
  }

  // Click ra ngo√†i ƒë·ªÉ ƒë√≥ng modal
  window.onclick = (e) => {
    const modal = document.getElementById('addressModal');
    if (e.target === modal) modal.style.display = 'none';
  };
</script>

<!-- ======================== -->
<!--   H√†nh ch√≠nh Vi·ªát Nam    -->
<!-- ======================== -->
<script>
(() => {
  const API = {
    provinces: '/api/vn/p',
    province:  (code) => `/api/vn/p-detail?code=${code}`,
    district:  (code) => `/api/vn/d-detail?code=${code}`,
  };

  const selCity     = document.getElementById('city');
  const selDistrict = document.getElementById('district');
  const selWard     = document.getElementById('ward');

  const CACHE = {
    provinces: null,
    districtsByProvinceCode: new Map(),
    wardsByDistrictCode: new Map(),
  };

  const removeAccents = (s) =>
    s?.normalize('NFD').replace(/[\u0300-\u036f]/g,'').replace(/ƒë/g,'d').replace(/ƒê/g,'D') ?? '';
  const sameName = (a, b) =>
    removeAccents(String(a)).trim().toLowerCase() === removeAccents(String(b)).trim().toLowerCase();

  function resetSelect(el, placeholder) {
    el.innerHTML = `<option value="">${placeholder}</option>`;
  }

  function fillOptions(el, items, textKey='name', valueKey='name') {
    items.forEach(it => {
      const op = document.createElement('option');
      op.value = it[valueKey];
      op.textContent = it[textKey];
      el.appendChild(op);
    });
  }

  // ========== Load Provinces ==========
  async function loadProvinces() {
    resetSelect(selCity,   '-- Ch·ªçn T·ªânh / Th√†nh ph·ªë --');
    resetSelect(selDistrict, '-- Ch·ªçn Qu·∫≠n / Huy·ªán --');
    resetSelect(selWard,     '-- Ch·ªçn X√£ / Ph∆∞·ªùng --');
    if (!CACHE.provinces) {
      const res = await fetch(API.provinces);
      if (!res.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i danh s√°ch T·ªânh/Th√†nh ph·ªë');
      CACHE.provinces = await res.json();
    }
    fillOptions(selCity, CACHE.provinces);
  }

  // ========== Load Districts theo Province ==========
  async function loadDistricts(provinceName) {
    resetSelect(selDistrict, '-- Ch·ªçn Qu·∫≠n / Huy·ªán --');
    resetSelect(selWard,     '-- Ch·ªçn X√£ / Ph∆∞·ªùng --');
    if (!provinceName) return;

    // t√¨m m√£ code c·ªßa province d·ª±a theo name
    let found = CACHE.provinces.find(p => sameName(p.name, provinceName));
    const code = found?.code;
    if (!code) return;

    if (!CACHE.districtsByProvinceCode.has(code)) {
      const res = await fetch(API.province(code));
      if (!res.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i danh s√°ch Qu·∫≠n/Huy·ªán');
      const data = await res.json();
      CACHE.districtsByProvinceCode.set(code, data.districts || []);
    }
    fillOptions(selDistrict, CACHE.districtsByProvinceCode.get(code));
  }

  // ========== Load Wards theo District ==========
  async function loadWards(districtName) {
    resetSelect(selWard, '-- Ch·ªçn X√£ / Ph∆∞·ªùng --');
    if (!districtName) return;

    let found;
    for (let [key, list] of CACHE.districtsByProvinceCode.entries()) {
      found = list.find(d => sameName(d.name, districtName));
      if (found) break;
    }
    const code = found?.code;
    if (!code) return;

    if (!CACHE.wardsByDistrictCode.has(code)) {
      const res = await fetch(API.district(code));
      if (!res.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i danh s√°ch X√£/Ph∆∞·ªùng');
      const data = await res.json();
      CACHE.wardsByDistrictCode.set(code, data.wards || []);
    }
    fillOptions(selWard, CACHE.wardsByDistrictCode.get(code));
  }

  // ========== S·ª± ki·ªán thay ƒë·ªïi ==========
  selCity?.addEventListener('change', async () => {
    await loadDistricts(selCity.value);
  });

  selDistrict?.addEventListener('change', async () => {
    await loadWards(selDistrict.value);
  });

  // ========== Prefill khi EDIT ==========
  window.prefillAdministrative = async (cityName, districtName, wardName) => {
    await loadProvinces();
    if (cityName) {
      selCity.value = cityName;
      await loadDistricts(cityName);
    }
    if (districtName) {
      selDistrict.value = districtName;
      await loadWards(districtName);
    }
    if (wardName) selWard.value = wardName;
  };

  window.prepareForCreateAddress = async () => {
    await loadProvinces();
  };

  // N·∫°p s·∫µn danh s√°ch t·ªânh khi trang m·ªü
  loadProvinces().catch(err => alert(err.message));
})();
</script>

<script>
  // üîπ T·ª± ·∫©n th√¥ng b√°o sau 3 gi√¢y
  setTimeout(() => {
    document.querySelectorAll('.alert').forEach(a => {
      a.style.opacity = '0';
      setTimeout(() => (a.style.display = 'none'), 500);
    });
  }, 3000);
</script>


</body>
</html>
