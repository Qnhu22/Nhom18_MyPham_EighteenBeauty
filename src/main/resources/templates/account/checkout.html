<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Thanh to√°n | OneShop</title>

  <!-- üîπ ƒê·ªìng b·ªô giao di·ªán -->
  <link rel="stylesheet" th:href="@{/css/header.css}">
  <link rel="stylesheet" th:href="@{/css/footer.css}">
  <link rel="stylesheet" th:href="@{/css/checkout.css}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>

<body>
  <!-- üîπ Header -->
  <div th:replace="fragments/_header :: header"></div>

 <main class="checkout-page">
  <div class="checkout-container">

    <h2 class="title">X√ÅC NH·∫¨N THANH TO√ÅN</h2>

    <!-- üè† ƒê·ªãa ch·ªâ giao h√†ng -->
    <div class="section">
      <h3>ƒê·ªãa ch·ªâ giao h√†ng</h3>
      <div class="address-box" th:if="${defaultAddress != null}">
        <div class="address-info">
          <p>
            <strong th:text="${defaultAddress.receiverName}"></strong> -
            <span th:text="${defaultAddress.phone}"></span>
          </p>
          <p th:text="${defaultAddress.addressLine + ', ' + defaultAddress.ward + ', ' 
                      + defaultAddress.district + ', ' + defaultAddress.city}"></p>
        </div>
        <a th:href="@{/account/addresses}" class="btn-change">Thay ƒë·ªïi</a>
      </div>

      <div class="address-box" th:if="${defaultAddress == null}">
        <p style="color: red;">‚ùå B·∫°n ch∆∞a c√≥ ƒë·ªãa ch·ªâ giao h√†ng. Vui l√≤ng th√™m trong t√†i kho·∫£n.</p>
        <a th:href="@{/account/addresses}" class="btn-change">Th√™m ƒë·ªãa ch·ªâ</a>
      </div>
    </div>

    <!-- üõç S·∫£n ph·∫©m trong ƒë∆°n -->
    <div class="section">
      <h3>S·∫£n ph·∫©m trong ƒë∆°n h√†ng</h3>
      <table class="order-table">
        <thead>
          <tr>
            <th>T√™n s·∫£n ph·∫©m</th>
            <th>SL</th>
            <th>Gi√°</th>
            <th>T·∫°m t√≠nh</th>
          </tr>
        </thead>
        <tbody>
          <tr th:each="item : ${items}">
            <td th:text="${item instanceof T(com.oneshop.entity.CartItem) ? item.productVariant.product.name : item['name']}"></td>
            <td th:text="${item instanceof T(com.oneshop.entity.CartItem) ? item.quantity : item['quantity']}"></td>
            <td th:text="${#numbers.formatDecimal(item instanceof T(com.oneshop.entity.CartItem) ? item.productVariant.price : item['price'], 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"></td>
            <td th:text="${#numbers.formatDecimal(item instanceof T(com.oneshop.entity.CartItem) ? item.subtotal : item['subtotal'], 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"></td>
          </tr>
        </tbody>
      </table>
    </div>

<!-- üéÅ Voucher -->
<div class="section voucher-section">
  <h3>Voucher</h3>

  <div class="voucher-box">
    <a th:href="@{/account/vouchers}" class="btn-voucher">
      <i class="fa-solid fa-gift"></i> √Åp d·ª•ng voucher
    </a>

    <div th:if="${session.selectedVoucher != null}" class="applied-voucher">
      <p>ƒê√£ √°p d·ª•ng: 
        <strong th:text="${session.selectedVoucher.code}"></strong> - 
        <span th:text="${session.selectedVoucher.name}"></span>
      </p>

      <p th:if="${session.selectedVoucher.discountType.name() == 'PERCENT'}">
        Gi·∫£m <b th:text="${session.selectedVoucher.discountPercent}"></b>% 
        <span th:if="${session.selectedVoucher.maxDiscountValue != null}">
          (T·ªëi ƒëa <span th:text="${#numbers.formatDecimal(session.selectedVoucher.maxDiscountValue, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"></span>)
        </span>
      </p>

      <p th:if="${session.selectedVoucher.discountType.name() == 'AMOUNT'}">
        Gi·∫£m <b th:text="${#numbers.formatDecimal(session.selectedVoucher.discountAmount, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"></b>
      </p>

      <p th:if="${session.selectedVoucher.discountType.name() == 'FREESHIP'}">Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn üöö</p>

      <a th:href="@{/account/vouchers/remove}" class="btn-remove">B·ªè ch·ªçn</a>
    </div>
  </div>
</div>

    <!-- üí≥ Ph∆∞∆°ng th·ª©c thanh to√°n -->
    <div class="section payment-methods">
      <h3>Ph∆∞∆°ng th·ª©c thanh to√°n</h3>
      <label><input type="radio" name="payment" value="COD" checked> Thanh to√°n khi nh·∫≠n h√†ng</label>
      <label><input type="radio" name="payment" value="Momo"> V√≠ Momo</label>
    </div>

<!-- üí∞ T·ªïng c·ªông -->
<div class="section summary-box">
  <p>T·∫°m t√≠nh: 
    <strong th:text="${#numbers.formatDecimal(subtotal, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"></strong>
  </p>

  <p>Ph√≠ v·∫≠n chuy·ªÉn: 
    <strong th:text="${#numbers.formatDecimal(shipFee, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"></strong>
  </p>

  <p th:if="${discount != null and discount > 0}">
    Gi·∫£m gi√°:
    <strong style="color:#16a34a" th:text="'- ' + ${#numbers.formatDecimal(discount, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"></strong>
  </p>

  <hr style="border:0.5px solid #ddd; margin:8px 0;">

  <p><b>T·ªïng c·ªông: 
    <span style="color:#8b5cf6; font-size:20px;"
          th:text="${#numbers.formatDecimal(total, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"></span>
  </b></p>
</div>


    <!-- üîò H√†nh ƒë·ªông -->
    <div class="action-buttons" style="display: flex; justify-content: flex-end; align-items: center; gap: 12px; margin-top: 25px;">
      
      <!-- üîô N√∫t quay l·∫°i -->
      <button type="button" class="btn-back" onclick="history.back()">
        <i class="fa-solid fa-arrow-left"></i> Quay l·∫°i
      </button>

      <!-- ‚úÖ Form thanh to√°n qua Momo (·∫©n) -->
      <form id="momoForm" th:action="@{/payment/momo/pay}" method="post" style="display:none;">
  <input type="hidden" name="amount" th:value="${total}"> <!-- s·ªë thu·∫ßn kh√¥ng format -->
</form>


      <!-- üí≥ N√∫t x√°c nh·∫≠n -->
      <button type="button" class="btn-confirm" id="confirmBtn">
        <i class="fa-solid fa-credit-card"></i> ƒê·∫∑t h√†ng
      </button>
    </div>

  </div>
</main>

<div th:replace="fragments/_footer :: footer"></div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const confirmBtn = document.getElementById("confirmBtn");
  if (!confirmBtn) return;

  confirmBtn.addEventListener("click", async () => {
    const payment = document.querySelector('input[name="payment"]:checked')?.value;

    try {
      if (payment === "Momo") {
        // üü£ N·∫øu ch·ªçn v√≠ Momo ‚Üí chuy·ªÉn sang trang thanh to√°n Momo
        document.getElementById("momoForm").submit();
      } else {
        // üü¢ V·ªõi COD ho·∫∑c Bank ‚Üí g·ª≠i x√°c nh·∫≠n ƒë∆°n h√†ng
        const formData = new FormData();
        formData.append("paymentMethod", payment.toUpperCase());

        const res = await fetch('/checkout/confirm', {
          method: 'POST',
          body: formData
        });

        if (res.redirected) {
          alert("‚úÖ ƒê·∫∑t h√†ng th√†nh c√¥ng! C·∫£m ∆°n b·∫°n ƒë√£ mua s·∫Øm t·∫°i OneShop üíú");
          window.location.href = res.url;
        } else {
          alert("‚ùå C√≥ l·ªói khi x√°c nh·∫≠n ƒë∆°n h√†ng. Vui l√≤ng th·ª≠ l·∫°i.");
        }
      }
    } catch (e) {
      console.error("L·ªói khi ƒë·∫∑t h√†ng:", e);
      alert("‚ö†Ô∏è L·ªói h·ªá th·ªëng, vui l√≤ng th·ª≠ l·∫°i sau.");
    }
  });
});
</script>

</body>
</html>
