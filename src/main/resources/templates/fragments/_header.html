<div th:fragment="header">
	<header class="oneshop-header" id="main-header">

		<!-- üîπ THANH TR√äN (TOP BAR) -->
		<div class="top-bar">
			<div class="container top-content">
				<div class="left">
					<span><i class="fa fa-phone"></i> (08) 123 456 7890</span>
					<span><i class="fa fa-envelope"></i> support@oneshop.vn</span>
					<span class="social">
						<a href="#"><i class="fab fa-facebook-f"></i></a>
						<a href="#"><i class="fab fa-instagram"></i></a>
						<a href="#"><i class="fab fa-pinterest-p"></i></a>
					</span>
				</div>

				<div class="right">
					<!-- üîê ƒêƒÉng nh·∫≠p / T√†i kho·∫£n -->
					<!-- üë§ Guest (·∫©n danh) -->
					<div class="dropdown login-dropdown" sec:authorize="isAnonymous()">
						<button class="dropbtn">
							<i class="fa fa-user"></i> Kh√°ch <i class="fa fa-caret-down arrow"></i>
						</button>

						<div class="dropdown-content">
							<a href="#"><i class="fa fa-heart"></i> Danh s√°ch y√™u th√≠ch</a>
							<a th:href="@{/login}"><i class="fa fa-sign-in-alt"></i> ƒêƒÉng nh·∫≠p</a>
						</div>
					</div>

					<!-- üë§ User ƒë√£ ƒëƒÉng nh·∫≠p -->
					<div class="dropdown login-dropdown" sec:authorize="isAuthenticated()">
						<button class="dropbtn">
							<i class="fa fa-user"></i>
							<span sec:authentication="name"></span>
							<i class="fa fa-caret-down arrow"></i>
						</button>

						<div class="dropdown-content account-menu">
							<a th:href="@{/account}"><i class="fa fa-id-card"></i> Th√¥ng tin t√†i kho·∫£n</a>
							<a th:href="@{/account/orders}"><i class="fa fa-shopping-bag"></i> L·ªãch s·ª≠ ƒë∆°n h√†ng</a>
							<a th:href="@{/account/vouchers}"><i class="fa fa-gift"></i> V√≠ Voucher</a>
							<a th:href="@{/account/addresses}"><i class="fa fa-map-marker-alt"></i> ƒê·ªãa ch·ªâ giao h√†ng</a>
							<a th:href="@{/account/reviews}"><i class="fa fa-star"></i> ƒê√°nh gi√° & ph·∫£n h·ªìi</a>

							<form th:action="@{/logout}" method="post">
								<button type="submit" class="logout-btn"><i class="fa fa-sign-out-alt"></i> ƒêƒÉng
									xu·∫•t</button>
							</form>
						</div>
					</div>

					<!-- üåê Ng√¥n ng·ªØ -->
					<div class="dropdown lang-dropdown">
						<button class="dropbtn">
							<img src="https://flagcdn.com/16x12/vn.png" alt="VN"> Ti·∫øng Vi·ªát
							<i class="fa fa-caret-down arrow"></i>
						</button>
						<div class="dropdown-content">
							<a href="#"><img src="https://flagcdn.com/16x12/vn.png" alt=""> Ti·∫øng Vi·ªát</a>
							<a href="#"><img src="https://flagcdn.com/16x12/gb.png" alt=""> English</a>
							<a href="#"><img src="https://flagcdn.com/16x12/kr.png" alt=""> ÌïúÍµ≠Ïñ¥</a>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- üî∏ THANH MENU CH√çNH -->
		<nav class="main-nav">
			<div class="container nav-content">
				<div class="logo">
					<a href="/" class="logo-text">Eighteen<span>beauty</span></a>
				</div>

				<ul class="menu">
					<li><a th:href="@{/}">TRANG CH·ª¶</a></li>
					<li><a th:href="@{/shop}">S·∫¢N PH·∫®M</a></li>
					<li><a th:href="@{/blog}">BLOG</a></li>
					<li><a th:href="@{/about}">GI·ªöI THI·ªÜU</a></li>
					<li><a th:href="@{/contact}">LI√äN H·ªÜ</a></li>
				</ul>

				<!-- üõí KHU V·ª∞C ICON -->
				<div class="actions">
					<!-- üîç √î t√¨m ki·∫øm -->
					<div class="search-wrapper">
						<img th:src="@{/images/icons/search.png}" alt="T√¨m ki·∫øm" class="icon-btn" id="searchToggle">
						<div class="mini-search" id="miniSearch">
							<input type="text" placeholder="Nh·∫≠p t·ª´ kh√≥a v√† nh·∫•n Enter">
							<button><img th:src="@{/images/icons/search.png}" alt="Search"></button>
						</div>
					</div>

    // Hi·ªán √¥ t√¨m ki·∫øm nh·ªè
    const searchToggle = document.getElementById("searchToggle");
    const miniSearch = document.getElementById("miniSearch");

						<!-- MINI CART DROPDOWN -->
						<div class="mini-cart" id="miniCart">
							<div class="mini-cart-items">

								<!-- üü£ Gi·ªè tr·ªëng -->
								<div th:if="${#lists.isEmpty(items)}" class="empty-cart">
									<p>Gi·ªè h√†ng tr·ªëng</p>
									<div class="mini-cart-actions">
										<a th:href="@{/cart}" class="btn-view">XEM GI·ªé H√ÄNG</a>
									</div>
								</div>

								<!-- üü¢ USER LOGIN: items l√† CartItem -->
								<th:block sec:authorize="isAuthenticated()">
									<th:block th:each="item : ${items}">
										<div class="mini-cart-item"
											th:attr="data-variantid=${item.productVariant.variantId}">
											<img th:src="${item.productVariant.imageUrl}" alt="·∫¢nh">
											<div class="details">
												<p th:text="${item.productVariant.product.name}"></p>
												<small
													th:text="${item.quantity} + ' √ó ' +
                            ${#numbers.formatDecimal(item.productVariant.price, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"></small>
											</div>
											<form th:action="@{/cart/remove}" method="post">
												<input type="hidden" name="variantId"
													th:value="${item.productVariant.variantId}">
												<button type="submit"><i class="fa fa-trash"></i></button>
											</form>
										</div>
									</th:block>
								</th:block>

								<!-- üîµ GUEST (·∫®n danh): items l√† Map -->
								<th:block sec:authorize="isAnonymous()">
									<th:block th:each="item : ${items}">
										<div class="mini-cart-item" th:attr="data-variantid=${item['variantId']}">
											<img th:src="${item['image']}" alt="·∫¢nh">
											<div class="details">
												<p th:text="${item['name']}"></p>
												<small th:text="${item['quantity']} + ' √ó ' +
                            ${#numbers.formatDecimal(item['price'], 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"></small>
											</div>
											<form th:action="@{/cart/remove}" method="post">
												<input type="hidden" name="variantId" th:value="${item['variantId']}">
												<button type="submit"><i class="fa fa-trash"></i></button>
											</form>
										</div>
									</th:block>
								</th:block>
							</div>

							<!-- üßæ T·ªïng c·ªông + n√∫t Xem gi·ªè h√†ng -->
							<div class="mini-cart-total" th:if="${items != null and !#lists.isEmpty(items)}">
								<p>
									T·ªïng c·ªông:
									<strong
										th:text="${#numbers.formatDecimal(total, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"></strong>
								</p>
								<div class="mini-cart-actions">
									<a th:href="@{/cart}" class="btn-view">XEM GI·ªé H√ÄNG</a>
								</div>
							</div>
						</div>

					</div>
				</div>
			</div>
		</nav>
	</header>

	<!-- ================== SCRIPT ================== -->
	<script>
		// Sticky Header
		window.addEventListener("scroll", function () {
			const header = document.getElementById("main-header");
			header.classList.toggle("sticky", window.scrollY > 80);
		});

		// Dropdown arrow animation
		document.querySelectorAll(".dropdown").forEach((drop) => {
			drop.addEventListener("mouseenter", () => drop.querySelector(".arrow").classList.add("rotate"));
			drop.addEventListener("mouseleave", () => drop.querySelector(".arrow").classList.remove("rotate"));
		});

		// Toggle mini search
		const searchToggle = document.getElementById("searchToggle");
		const miniSearch = document.getElementById("miniSearch");
		document.addEventListener("click", (e) => {
			if (searchToggle.contains(e.target)) {
				miniSearch.classList.toggle("active");
			} else if (!miniSearch.contains(e.target)) {
				miniSearch.classList.remove("active");
			}
		});
	</script>

	<!-- ================== SCRIPT B·ªî SUNG ƒê·ªíNG B·ªò MINI CART ================== -->
	<script>
		document.addEventListener("DOMContentLoaded", async () => {
			const cartBadge = document.getElementById("cartCount");
			const miniCart = document.getElementById("miniCart");
			const miniList = miniCart?.querySelector(".mini-cart-items");

			// ‚úÖ Khi load trang: ƒë·ªìng b·ªô badge + x√≥a "Gi·ªè h√†ng tr·ªëng" n·∫øu c√≥
			try {
				const res = await fetch("/cart/api/status");
				if (res.ok) {
					const data = await res.json();
					if (cartBadge) cartBadge.textContent = data.cartCount;

					if (data.cartCount > 0) {
						const empty = miniList?.querySelector("p");
						if (empty && empty.textContent.includes("Gi·ªè h√†ng tr·ªëng")) {
							empty.remove();
						}
					}
				}
			} catch (e) {
				console.warn("Kh√¥ng th·ªÉ l·∫•y tr·∫°ng th√°i gi·ªè h√†ng:", e);
			}

			// ‚úÖ Khi c√≥ s·ª± ki·ªán th√™m s·∫£n ph·∫©m t·ª´ product-detail
			window.addEventListener("cart-updated", (e) => {
				const {name, variantId, qty, price, image, total} = e.detail;
				if (!miniList) return;

				// ·∫®n d√≤ng "Gi·ªè h√†ng tr·ªëng"
				const empty = miniList.querySelector("p");
				if (empty && empty.textContent.includes("Gi·ªè h√†ng tr·ªëng")) empty.remove();

				// üîÑ G·ªôp theo variantId (KH√îNG g·ªôp ch·ªâ theo t√™n)
				const exist = Array.from(miniList.querySelectorAll(".mini-cart-item"))
					.find(el => el.dataset.variantid === String(variantId));

				if (exist) {
					const small = exist.querySelector("small");
					const oldQty = parseInt(small.textContent.split("√ó")[0].trim()) || 0;
					small.textContent = `${oldQty + qty} √ó ${price}`;
				} else {
					const html = `
    		  <div class="mini-cart-item" data-variantid="${variantId}">
    		    <img src="${image}" alt="">
    		    <div class="details">
    		      <p>${name}</p>
    		      <small>${qty} √ó ${price}</small>
    		    </div>
    		    <form action="/cart/remove" method="post" class="remove-form">
    		      <input type="hidden" name="variantId" value="${variantId}">
    		      <button type="submit"><i class="fa fa-trash"></i></button>
    		    </form>
    		  </div>`;

					miniList.insertAdjacentHTML("beforeend", html);
				}

				// üßæ C·∫≠p nh·∫≠t t·ªïng c·ªông + badge
				let totalEl = document.querySelector(".mini-cart-total strong");

				if (totalEl) {
					// ƒê√£ c√≥ block t·ªïng ‚Üí ch·ªâ c·∫≠p nh·∫≠t s·ªë ti·ªÅn
					totalEl.textContent = total.toLocaleString("vi-VN") + " ‚Ç´";
				} else {
					// Ch∆∞a c√≥ block t·ªïng ‚Üí t·∫°o m·ªõi (ch·ªâ c√≤n n√∫t Xem gi·ªè h√†ng)
					const oldTotal = miniCart.querySelector(".mini-cart-total");
					if (oldTotal) oldTotal.remove(); // tr√°nh tr√πng

					const wrapper = document.createElement("div");
					wrapper.classList.add("mini-cart-total");
					wrapper.innerHTML = `
          <p>T·ªïng c·ªông: <strong>${total.toLocaleString("vi-VN")} ‚Ç´</strong></p>
          <div class="mini-cart-actions">
            <a href="/cart" class="btn-view">XEM GI·ªé H√ÄNG</a>
          </div>`;
					miniCart.appendChild(wrapper);
				}

				if (cartBadge) cartBadge.textContent = parseInt(cartBadge.textContent || 0) + qty;

				// üí´ Hi·ªáu ·ª©ng rung gi·ªè h√†ng
				const icon = document.getElementById("cartIcon");
				if (icon) {
					icon.classList.add("cart-shake");
					setTimeout(() => icon.classList.remove("cart-shake"), 600);
				}
			});
		});

		//üóë X√≥a s·∫£n ph·∫©m tr·ª±c ti·∫øp trong mini-cart (AJAX)
		document.addEventListener("click", async (e) => {
			const btn = e.target.closest(".mini-cart-item form button");
			if (!btn) return; // n·∫øu kh√¥ng ph·∫£i n√∫t x√≥a th√¨ b·ªè qua

			e.preventDefault(); // üö´ kh√¥ng cho redirect

			const form = btn.closest("form");
			const variantId = form.querySelector("input[name='variantId']").value;
			const itemEl = btn.closest(".mini-cart-item");

			try {
				const res = await fetch("/cart/remove", {
					method: "POST",
					body: new URLSearchParams({variantId})
				});

				if (!res.ok) throw new Error("L·ªói HTTP " + res.status);

				// ‚úÖ X√≥a d√≤ng kh·ªèi mini-cart
				itemEl.remove();

				// ‚úÖ G·ªçi l·∫°i API tr·∫°ng th√°i ƒë·ªÉ c·∫≠p nh·∫≠t t·ªïng & badge
				const statusRes = await fetch("/cart/api/status");
				if (statusRes.ok) {
					const data = await statusRes.json();
					const totalEl = document.querySelector(".mini-cart-total strong");
					const badge = document.getElementById("cartCount");

					if (totalEl) totalEl.textContent = data.total.toLocaleString("vi-VN") + " ‚Ç´";
					if (badge) badge.textContent = data.cartCount;

					// N·∫øu kh√¥ng c√≤n item n√†o ‚Üí hi·ªÉn th·ªã "Gi·ªè h√†ng tr·ªëng" + n√∫t Xem gi·ªè h√†ng
					const miniList = document.querySelector(".mini-cart-items");
					if (miniList && miniList.querySelectorAll(".mini-cart-item").length === 0) {
						miniList.innerHTML = `
            <div class="empty-cart">
              <p>Gi·ªè h√†ng tr·ªëng</p>
              <div class="mini-cart-actions">
                <a href="/cart" class="btn-view">XEM GI·ªé H√ÄNG</a>
              </div>
            </div>
          `;
						const totalBlock = document.querySelector(".mini-cart-total");
						if (totalBlock) totalBlock.remove();
					}

				}

			} catch (err) {
				console.error("X√≥a s·∫£n ph·∫©m th·∫•t b·∫°i:", err);
				alert("Kh√¥ng th·ªÉ x√≥a s·∫£n ph·∫©m. Vui l√≤ng th·ª≠ l·∫°i!");
			}
		});

	</script>
</div>