<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Gi·ªè h√†ng - OneShop</title>
  <link rel="stylesheet" th:href="@{/css/header.css}">
  <link rel="stylesheet" th:href="@{/css/footer.css}">
  <link rel="stylesheet" th:href="@{/css/cart.css}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
</head>

<body>
<div th:replace="fragments/_header :: header"></div>

<main class="cart-container">
  <div class="container">
    <h2>üõí Gi·ªè h√†ng c·ªßa b·∫°n</h2>

    <!-- Gi·ªè tr·ªëng -->
    <div th:if="${items == null or #lists.isEmpty(items)}" class="empty-cart">
      <i class="fa-solid fa-cart-arrow-down"></i>
      <p>Gi·ªè h√†ng c·ªßa b·∫°n ƒëang tr·ªëng</p>
      <a th:href="@{/shop}" class="btn-continue">Ti·∫øp t·ª•c mua s·∫Øm</a>
    </div>

    <!-- C√≥ s·∫£n ph·∫©m -->
    <div th:if="${items != null and !#lists.isEmpty(items)}" class="cart-table">
      <table>
        <thead>
          <tr>
            <th>S·∫£n ph·∫©m</th>
            <th>Gi√°</th>
            <th>S·ªë l∆∞·ª£ng</th>
            <th>T·∫°m t√≠nh</th>
            <th></th>
          </tr>
        </thead>
<tbody>
  <tr th:each="item : ${items}">
    <!-- üß© N·∫øu l√† user ƒë√£ ƒëƒÉng nh·∫≠p -->
    <td class="product-info" th:if="${item instanceof T(com.oneshop.entity.CartItem)}">
      <img th:src="${item.productVariant.imageUrl}" alt="·∫¢nh s·∫£n ph·∫©m">
      <div>
        <h4 th:text="${item.productVariant.product.name}"></h4>
        <small th:text="'M√†u: ' + ${item.productVariant.color}"></small><br>
        <small th:text="'K√≠ch th∆∞·ªõc: ' + ${item.productVariant.size}"></small>
      </div>
    </td>

    <!-- üß≥ N·∫øu l√† kh√°ch -->
    <td class="product-info" th:if="${!(item instanceof T(com.oneshop.entity.CartItem))}">
      <img th:src="${item['image']}" alt="·∫¢nh s·∫£n ph·∫©m">
      <div>
        <h4 th:text="${item['name']}"></h4>
        <small th:if="${item['color'] != null}" th:text="'M√†u: ' + ${item['color']}"></small><br>
        <small th:if="${item['size'] != null}" th:text="'K√≠ch th∆∞·ªõc: ' + ${item['size']}"></small>
      </div>
    </td>

    <!-- Gi√° -->
    <td th:if="${item instanceof T(com.oneshop.entity.CartItem)}"
        th:text="${#numbers.formatDecimal(item.productVariant.price, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"></td>
    <td th:if="${!(item instanceof T(com.oneshop.entity.CartItem))}"
        th:text="${#numbers.formatDecimal(item['price'], 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"></td>

    <!-- S·ªë l∆∞·ª£ng -->
    <td class="qty-cell">
      <form th:action="@{/cart/update}" method="post" class="qty-form">
        <input type="hidden" name="variantId"
               th:value="${item instanceof T(com.oneshop.entity.CartItem) ? item.productVariant.variantId : item['variantId']}">
        <button type="button" class="btn-qty minus">‚àí</button>
        <input type="number" name="quantity"
               th:value="${item instanceof T(com.oneshop.entity.CartItem) ? item.quantity : item['quantity']}" min="1">
        <button type="button" class="btn-qty plus">+</button>
      </form>
    </td>

    <!-- T·∫°m t√≠nh -->
    <td th:text="${#numbers.formatDecimal(
        (item instanceof T(com.oneshop.entity.CartItem)) ? item.subtotal : item['subtotal'],
        0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"></td>

    <!-- X√≥a -->
    <td>
      <form th:action="@{/cart/remove}" method="post">
        <input type="hidden" name="variantId"
               th:value="${item instanceof T(com.oneshop.entity.CartItem) ? item.productVariant.variantId : item['variantId']}">
        <button type="submit" class="btn-remove"><i class="fa-solid fa-trash"></i></button>
      </form>
    </td>
  </tr>
</tbody>


      </table>
    </div>

    <!-- T·ªïng c·ªông -->
    <div th:if="${total > 0}" class="cart-summary">
      <p>T·ªïng c·ªông: <strong th:text="${#numbers.formatDecimal(total, 0, 'COMMA', 0, 'POINT')} + ' ‚Ç´'"></strong></p>
      <div class="cart-actions">
  <!-- üîô Ti·∫øp t·ª•c mua h√†ng -->
  <button type="button" class="btn-continue" onclick="goBackOrShop()">
    <i class="fa-solid fa-arrow-left"></i> Ti·∫øp t·ª•c mua h√†ng
  </button>

  <form th:action="@{/cart/clear}" method="post">
    <button type="submit" class="btn-clear">
      <i class="fa-solid fa-xmark"></i> X√≥a t·∫•t c·∫£
    </button>
  </form>

  <a th:href="@{/cart/checkout}" class="btn-checkout">
  <i class="fa-solid fa-credit-card"></i> Thanh to√°n
</a>

</div>

    </div>
  </div>
</main>

<div th:replace="fragments/_footer :: footer"></div>

<script>
function goBackOrShop() {
  const prev = document.referrer;
  if (prev && !prev.includes('/cart')) {
    window.history.back(); // quay l·∫°i trang tr∆∞·ªõc
  } else {
    window.location.href = '/shop'; // ho·∫∑c v√†o trang shop
  }
}
</script>

<script>
document.addEventListener('click', async (e) => {
  const btn = e.target.closest('.btn-qty');
  if (!btn) return;

  const form = btn.closest('.qty-form');
  const input = form.querySelector('input[name="quantity"]');
  let qty = parseInt(input.value);

  if (btn.classList.contains('plus')) qty++;
  else if (btn.classList.contains('minus') && qty > 1) qty--;

  input.value = qty;

  // üü£ G·ª≠i AJAX c·∫≠p nh·∫≠t
  const variantId = form.querySelector('input[name="variantId"]').value;
  const res = await fetch('/cart/update', {
    method: 'POST',
    headers: {'Content-Type': 'application/x-www-form-urlencoded'},
    body: new URLSearchParams({variantId, quantity: qty})
  });

  if (res.ok) {
    const data = await res.json();

    // ‚úÖ C·∫≠p nh·∫≠t subtotal & t·ªïng c·ªông
    form.closest('tr').querySelector('td:nth-child(4)').textContent =
      data.itemSubtotal.toLocaleString('vi-VN') + ' ‚Ç´';
    document.querySelector('.cart-summary strong').textContent =
      data.total.toLocaleString('vi-VN') + ' ‚Ç´';

    // ‚úÖ Lu√¥n ƒë·ªìng b·ªô badge b·∫±ng API (fix tri·ªát ƒë·ªÉ l·ªói header fragment)
    try {
      const statusRes = await fetch("/cart/api/status");
      if (statusRes.ok) {
        const status = await statusRes.json();
        const badge = document.querySelector("#cartCount");
        if (badge) badge.textContent = status.cartCount;
      }
    } catch (err) {
      console.warn("Kh√¥ng th·ªÉ ƒë·ªìng b·ªô badge realtime:", err);
    }

    // üí´ Hi·ªáu ·ª©ng rung nh·∫π gi·ªè h√†ng cho sinh ƒë·ªông
    const icon = document.getElementById('cartIcon');
    if (icon) {
      icon.classList.add('cart-shake');
      setTimeout(() => icon.classList.remove('cart-shake'), 600);
    }
  } else {
    console.error("Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng s·∫£n ph·∫©m");
  }
});
</script>

</body>
</html>
